<script>
$( document ).ready(function() {
  //Instantiate variables to hold pieces and unoccupied locations
  var $boardPieces = $( "td > p" ).filter(function( index ) {
      return $( this ).attr( "id" ) !== "empty";
    });
  var $emptySquares = $( "td#unoccupied" );
  //Make pieces draggable
  $( $boardPieces ).draggable({
      revert: "invalid",
      containment: "table",
      cursor: "crosshair"
    });
  //Make empty squares droppable
  $( $emptySquares ).droppable({
    tolerance: "intersect",
    accept: $boardPieces,
    drop: function ( event, ui ) {
      var currentCol = $( ui.draggable ).parent();
        console.log( "Current column is " + $( currentCol ).data( "id" ));
      var currentRow = $( currentCol ).parent();
        console.log( "Current row is " + $( currentRow ).data( "id" ));
      var newCol = $( event.target );
        console.log( "New col is " + newCol.data( "id" ) );
      var newRow = $( newCol ).parent();
        console.log( "New row is " + newRow.data( "id" ) );
      var currentPiece = $(ui.draggable);
      //Update piece position
      var gameId = $( ".gameBoard" ).data( "id" );
        $.post("/games/" + gameId + "/pieces/" + $( currentPiece ).data( "id"), {
          _method: "PUT",
          piece: {
            x_pos: newRow.data( "id" ),
            y_pos: newCol.data( "id" )
          }
        }).success( function( data ) {
          console.log( data );
          console.log( $( currentRow ).prev().prop( 'lastElementChild' ));
          $( currentRow ).prev( "td" ).attr( "id", "unoccupied" );
          console.log( $( currentRow ).prev( "td" ).attr( "id") );
          console.log(  $( newRow ).prev( "td" ).attr( "id" ) );
          $( newRow ).prev( "td" ).attr( "id", "occupied" );
        });       
     } 
  });
  //Attach delegated event handler
  $( "td#occupied" ).on( "click", "p", function( event ) {
    var $piece = $( this );
    console.log( $piece );
  });
  //Build JS representation of piece HTML
  function pieceHTML( piece ) {
    var pElement = '<p id="' + piece.type + '_' + piece.piece_color + '"' + 
      ' data-id="' + piece.id + '">';
    return pElement;
  };
});
</script>

<div class="booyah-box col-12">           
  <h1>Welcome to the game</h1>
  <%= link_to 'Forfeit?', game_path(@game), method: :delete, data: {confirm: 'Are you sure you want to delete this?'}, class: 'btn btn-danger' %>
  <div class="gameBoard" data-id="<%= @game.id %>">
    <table>
      <tbody>
        <% 8.times do |row| %>
          <tr data-id="<%= row %>">
            <% 8.times do |col|%>

              <% piece = @game.pieces.
                where(
                x_pos: row, 
                y_pos: col 
                ).first %>

              <% if (row+col) % 2 == 0 %>
                  <% if piece %> 
                    <td id="occupied" class="whiteSquare" data-id="<%= col %>">
                      <p id="<%= piece ? piece.type + "_" + piece.piece_color : "" %>" data-id="<%= piece ? piece.id : "" %>"><%= piece ? piece.symbol : ""  %></p>
                    </td>
                  <% else %>
                    <td id="unoccupied" class="whiteSquare" data-id="<%= col %>"></td>
                  <% end %>
              <% else %>
                  <% if piece %> 
                    <td id="occupied" class="blackSquare" data-id="<%= col %>">
                      <p id="<%= piece ? piece.type + "_" + piece.piece_color : "" %>" data-id="<%= piece ? piece.id : "" %>"><%= piece ? piece.symbol : ""  %></p>
                    </td>
                  <% else %>
                    <td id="unoccupied" class="blackSquare" data-id="<%= col %>"></td>
                  <% end %>
              <% end %>        
            <% end %>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
  <div class="moveForm">
    <%= form_tag move_game_piece_path(@game) do %>
      <%= hidden_field_tag "access_token", @access_token %>
      <%= number_field_tag "start_x", nil, class: "form-control", placeholder: "Starting X (Vertical)"%>
      <%= number_field_tag "start_y", nil, class: "form-control", placeholder: "Starting Y (Horizontal)" %>
      <%= number_field_tag "end_x", nil, class: "form-control", placeholder: "Ending X (Vertical)" %>
      <%= number_field_tag "end_y", nil, class: "form-control", placeholder: "Ending Y (Horizontal)" %>
      <%= submit_tag "Make a Move", class: "btn btn-danger" %>
    <% end %>
  </div>
</div> 
